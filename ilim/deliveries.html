<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>ИЛИМ</title>

  <link href="css/classic.css" rel="stylesheet">
</head>
<body>
	<div class="wrapper">
		<nav class="sidebar sidebar-sticky">
			<div class="sidebar-content">
				<a class="sidebar-brand" href="index.html">
					<img src="img/project/logo.png" alt="">
				</a>
					
				<ul class="sidebar-nav">
					<li class="sidebar-item active">
						<a href="deliveries.html" class="sidebar-link">
							<span class="">Поставки сырья</span>
						</a>
					</li>
					<li class="sidebar-item">
						<a href="provision.html" class="sidebar-link">
							<span class="">Обеспечение сырьем</span>
						</a>
					</li>
					<li class="sidebar-item">
						<a href="cuttings.html" class="sidebar-link">
							<span class="">Лесосеки</span>
						</a>
					</li>
					<li class="sidebar-item">
						<a href="area-searching.html" class="sidebar-link">
							<span class="">Поиск участка</span>
						</a>
					</li>
					<li class="sidebar-item">
						<a href="gantt.html" class="sidebar-link">
							<span class="">План поставок</span>
						</a>
					</li>
				</ul>
			</div>
		</nav>
		<div class="main">
			<nav class="navbar navbar-expand navbar-light bg-white">
				<a class="sidebar-toggle d-flex mr-2">
					<i class="hamburger align-self-center"></i>
				</a>

				<form class="form-inline d-none d-sm-inline-block">
					<input class="form-control form-control-no-border mr-sm-2" type="text" placeholder="Поиск" aria-label="Search">
				</form>

				<div class="navbar-collapse collapse">
					<ul class="navbar-nav ml-auto">
						<li class="nav-item dropdown"><a href="#" class="nav-icon">
								<i class="align-middle" data-feather="bar-chart-2"></i>
								<span class="align-middle">Аналитика</span></a></li>
						<li class="nav-item dropdown"><a href="#" class="nav-icon">
								<i class="align-middle" data-feather="users"></i>
								<span class="align-middle">Совет директоров</span>
							</a></li>
						<!--li class="nav-item dropdown"><a href="#" class="nav-icon">
								<i class="align-middle" data-feather="user"></i>
								<span class="align-middle">Правление</span>
							</a></li-->
						<li class="nav-item dropdown"><a href="#" class="nav-icon">
								<i class="align-middle" data-feather="tv"></i>
								<span class="align-middle">СМИ</span>
							</a></li>
					</ul>
				</div>
			</nav>
			
			<main class="content">
				<div class="container-fluid p-0">
					<h1 class="h3 mb-3">Сценарии поставки сырья</h1>
					<div class="main">
						<div class="row widgets">
							<div class="col-12 col-sm-6 col-xl d-flex">
								<div class="card flex-fill">
									<div class="card-body py-4">
										<div class="media">
											<div class="d-inline-block mt-2 mr-3">
												<i class="feather-lg text-primary" data-feather="shopping-cart"></i>
											</div>
											<div class="media-body">
												<h3 class="mb-2">
													<div class="spinner-border text-dark mr-2" role="status">
														<span class="sr-only">Loading...</span>
													</div>
												</h3>
												<div class="mb-0">Годовая собственная заготовка, тыс. м3</div>
											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="col-12 col-sm-6 col-xl d-flex">
								<div class="card flex-fill">
									<div class="card-body py-4">
										<div class="media">
											<div class="d-inline-block mt-2 mr-3">
												<i class="feather-lg text-warning" data-feather="activity"></i>
											</div>
											<div class="media-body">
												<h3 class="mb-2">
													<div class="spinner-border text-dark mr-2" role="status">
														<span class="sr-only">Loading...</span>
													</div>
												</h3>
												<div class="mb-0">Годовая собственная заготовка, млн. руб</div>
											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="col-12 col-sm-6 col-xl d-flex">
								<div class="card flex-fill">
									<div class="card-body py-4">
										<div class="media">
											<div class="d-inline-block mt-2 mr-3">
												<i class="feather-lg text-success" data-feather="dollar-sign"></i>
											</div>
											<div class="media-body">
												<h3 class="mb-2">
													<div class="spinner-border text-dark mr-2" role="status">
														<span class="sr-only">Loading...</span>
													</div>
												</h3>
												<div class="mb-0">Годовая сторонняя заготовка, тыс. м3</div>
											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="col-12 col-sm-6 col-xl d-flex">
								<div class="card flex-fill">
									<div class="card-body py-4">
										<div class="media">
											<div class="d-inline-block mt-2 mr-3">
												<i class="feather-lg text-danger" data-feather="shopping-bag"></i>
											</div>
											<div class="media-body">
												<h3 class="mb-2">
													<div class="spinner-border text-dark mr-2" role="status">
														<span class="sr-only">Loading...</span>
													</div>
												</h3>
												<div class="mb-0">Годовая сторонняя заготовка, млн. руб</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="row mt-3">
							<div class="col-sm-12 col-lg-9 order-2 order-lg-1">
								<div class="row">
									<div class="col-12 col-lg-6">
										<div class="card">
											<div class="card-header">
												<h5 class="card-title">Оптимальный сценарий собственной заготовки</h5>
												<h6 class="card-subtitle text-muted"></h6>
											</div>
											<div class="card-body">
												<div class="chart chart-sm">
													<div id="apexcharts-column-0"></div>
												</div>
											</div>
										</div>
									</div>
									<div class="col-12 col-lg-6">
										<div class="card">
											<div class="card-header">
												<h5 class="card-title">Фактическая собственная заготовка</h5>
												<h6 class="card-subtitle text-muted"></h6>
											</div>
											<div class="card-body">
												<div class="chart chart-sm">
													<div id="apexcharts-column-1"></div>
												</div>
											</div>
										</div>
									</div>
									<div class="col-12 col-lg-6">
										<div class="card">
											<div class="card-header">
												<h5 class="card-title">Оптимальный сценарий заготовки сторонникми ресурсами</h5>
												<h6 class="card-subtitle text-muted"></h6>
											</div>
											<div class="card-body">
												<div class="chart chart-sm">
													<div id="apexcharts-column-2"></div>
												</div>
											</div>
										</div>
									</div>
									<div class="col-12 col-lg-6">
										<div class="card">
											<div class="card-header">
												<h5 class="card-title">Фактическая заготовка сторонними ресурсами</h5>
												<h6 class="card-subtitle text-muted"></h6>
											</div>
											<div class="card-body">
												<div class="chart chart-sm">
													<div id="apexcharts-column-3"></div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="col-sm-12 col-lg-3 order-1 order-lg-2">
								<div class="card">
									<div class="card-header">
										<h5 class="card-title mb-0">Период</h5>
									</div>
									<div class="card-body">
										<div class="row">
											<label class="col-12">Год:</label>
											<div class="col-12">
												<select class="custom-select flex-grow-1" name="year">
													<option>Не выбран...</option>
												</select>
											</div>
										</div>
										<div class="row mt-3">
											<label class="col-12">Месяц:</label>
											<div class="col-12">
												<select class="custom-select flex-grow-1" name="month">
													<option>Не выбран...</option>
												</select>
											</div>
										</div>
									</div>
								</div>
								<div class="card">
									<div class="card-header">
										<h5 class="card-title mb-0">Единицы измерения</h5>
									</div>
									<div class="card-body">
										<label class="custom-control custom-radio">
											<input name="units" type="radio" class="custom-control-input" checked value="dlvrd" data-text="тыс. м3">
											<span class="custom-control-label">Объем, тыс. м<sup>3</sup></span>
										</label>
										<label class="custom-control custom-radio">
											<input name="units" type="radio" class="custom-control-input" value="dlvrd*prc" data-text="тыс. руб">
											<span class="custom-control-label">Стоимость, тыс. руб</span>
										</label>
									</div>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-10">
								<div id="apexcharts-legend"></div>
							</div>
						</div>
				</div>
			</main>

			<footer class="footer">
				<div class="container-fluid">
					<div class="row text-muted">
						<div class="col-6 text-left">
							<ul class="list-inline">
								<li class="list-inline-item">
									<a class="text-muted" href="#">Support</a>
								</li>
								<li class="list-inline-item">
									<a class="text-muted" href="#">Help Center</a>
								</li>
								<li class="list-inline-item">
									<a class="text-muted" href="#">Privacy</a>
								</li>
								<li class="list-inline-item">
									<a class="text-muted" href="#">Terms of Service</a>
								</li>
							</ul>
						</div>
						<div class="col-6 text-right">
							<p class="mb-0">
								© 2019 - <a href="index.html" class="text-muted">AppStack</a>
							</p>
						</div>
					</div>
				</div>
			</footer>
		</div>
	</div>
	<script src="js/app.js"></script>
	<script>
		var charts = [];
		let widgetsSettings = [
			{supply_ilim_base: ['dlvrd_sft_frst', 'dlvrd_hrd_frst','dlvrd_sft_chps', 'dlvrd_hrd_chps']},
			{supply_ilim_base: ['prc_sft_frst', 'prc_hrd_frst','prc_sft_chps', 'prc_hrd_chps']},
			{supply_partners_base: ['dlvrd_sft_frst', 'dlvrd_hrd_frst','dlvrd_sft_chps', 'dlvrd_hrd_chps']},
			{supply_partners_base: ['prc_sft_frst', 'prc_hrd_frst','prc_sft_chps', 'prc_hrd_chps']}
		];

		function redrawGroup(settings) {
			let val = $('input[name="units"]:checked').val().split('*');

			let s1 = null;
			if (val.length == 2) {
				s1 = prepareData(settings, 'date', val[0]);
				s2 = prepareData(settings, 'date', val[1]);
				s1.data = Object.keys(s1.data).map(function(i) {
					return Object.keys(s1.data[i]).map(j => s1.data[i][j] * s2.data[i][j] / 1000)
				})
			} else {
				s1 = prepareData(settings, 'date');
				s1.data = s1.data.map(v1 => v1.map(v2 => v2 / 1000));
			}

			for (let i in s1['data']) {
				charts[i].updateSeries(s1['data'][i]);
			}
		}

		function GroupLegend(legendChart, groupCharts) {
			window._chartGroupsData[legendChart.legend] = groupCharts.map(function(chart) {
				return {'ctx': chart, 'w': chart.w}
			});
		}

		$(function() {
			createIntervalFilter();

			updateWidgets(prepareData(widgetsSettings, 'date', null, false).data)

			$(document).on('change', 'select[name="year"]', function() {
				createIntervalFilter();

				redrawGroup(settings);
				
				updateWidgets(prepareData(widgetsSettings, 'date', null, false).data)
			});

			$(document).on('change', 'select[name="month"]', function() {
				redrawGroup(settings);
			});

			$(document).on('click', 'input[name="units"]', function(e) {
				redrawGroup(settings);
			});

			var options = {
				colors: colors,
				chart: {
					type: "donut"
				},
				plotOptions: {
					pie: {
						donut: {
							labels: {
								show: true,
								name: {
									show: false,
								},
								value: {
									show: true,
									formatter: function (val) {
										return Math.floor(val) + ' ' + unitsText;
									}
								},
								total: {
									show: true,
									formatter: function (w) {
										return Math.floor(w.globals.seriesTotals.reduce((a, b) => {
											return a + b
										}, 0)) + ' ' + unitsText
									}
								}
							}
						}
					}
				},
				legend: {
					show: false,
					fontSize: '22px',
					itemMargin: {
						vertical: 20
					},
				}
			}
			
			let containers = ['#apexcharts-column-0', '#apexcharts-column-1', '#apexcharts-column-2', '#apexcharts-column-3', '#apexcharts-legend'];
			let columns = ['{}_sft_frst', '{}_hrd_frst', '{}_sft_chps', '{}_hrd_chps']
			var settings = [
				{'supply_ilim_optmzd': columns},
				{'supply_ilim_base': columns},
				{'supply_partners_optmzd': columns},
				{'supply_partners_base': columns}
			]

			let series = prepareData(settings);
			series.data = series.data.map(v1 => v1.map(v2 => v2 / 1000));
			options['labels'] = series['labels'].filter(function(item, pos, self) {return self.indexOf(item) == pos});

			let queue = [];
			for(let i = 0; i < settings.length + 1; i++) {
				let opt = $.extend(true, {}, options);

				opt.series = [];
				if(i >= settings.length) {
					opt.plotOptions = {};
					opt.chart.height = '80px';
					opt.legend = Object.assign({}, opt.legend, {show: true, position: 'top'});

				} else {
					opt.series = series['data'][i];
				}
				queue.push(opt);
			}
			
			queue.forEach(function(opt, i) {
				let chart = new ApexCharts(document.querySelector(containers[i]), opt);
				chart.render();
				
				charts.push(chart);
			});

			let groupCharts = [];
			let groupLegend = undefined;
			for(let i = 0; i < settings.length + 1; i++){
				if(i >= settings.length) {
					groupLegend = charts[i];
				}
				else {
					groupCharts.push(charts[i]);
				}
			}

			GroupLegend(groupLegend, groupCharts);
		});
	</script>
</body>
</html>